- name: Resolve Swarm manager IP dynamically
  set_fact:
    swarm_manager_ip: "{{ hostvars[groups['swarm_managers'][0]].ansible_host }}"

- name: Check if Swarm is already initialized
  command: docker info --format '{{ '{{' }} .Swarm.LocalNodeState {{ '}}' }}'
  register: swarm_state
  changed_when: false

# --- Manager ---

- name: Initialize Docker Swarm on manager
  command: docker swarm init --advertise-addr {{ swarm_manager_ip }}
  when:
    - inventory_hostname in groups['swarm_managers']
    - swarm_state.stdout != 'active'

- name: Get worker join token
  command: docker swarm join-token worker -q
  register: worker_join_token
  changed_when: false
  when: inventory_hostname in groups['swarm_managers']

- name: Distribute worker join token to all nodes
  set_fact:
    swarm_worker_token: "{{ hostvars[groups['swarm_managers'][0]].worker_join_token.stdout }}"

# --- Worker ---

- name: Join worker nodes to Swarm
  command: >
    docker swarm join
    --token {{ swarm_worker_token }}
    {{ swarm_manager_ip }}:2377
  when:
    - inventory_hostname in groups['swarm_workers']
    - swarm_state.stdout != 'active'
